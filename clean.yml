# - name: Configure licensing
#   hosts: firewall:&virl_hosts
#   gather_facts: no
#   connection: network_cli
#   tasks:
#     - name: Deregister from smart account
#       asa_command:
#         commands:
#           - "license smart deregister"
#       ignore_errors: yes

- hosts: localhost
  connection: local
  gather_facts: no
  roles:
    - ansible-virl
  tags:
    - keys
  tasks:
#  - name: Find previously created certs
#    find:
#      paths: "{{ viptela_cert_dir }}"
#      patterns: '*.pem,*.key,*.csr,*.crt'
#    register: find_results
#
#  - name: Delete previously created certs
#    file:
#      path: "{{ item['path'] }}"
#      state: absent
#    with_items: "{{ find_results['files'] }}"

  - name: Delete cert dir
    file:
      path: "{{ viptela_cert_dir }}"
      state: absent

  - name: Remove host from known_hosts
    known_hosts:
      name: "{{ hostvars[item].ansible_host }}"
      state: absent
    when: hostvars[item].ansible_host is defined
    loop: "{{ groups.all }}"

- hosts: virl_hosts
  connection: local
  gather_facts: no
  roles:
    - ansible-virl
  tasks:
    - name: Stop the node
      virl_node:
        host: "{{ virl_host }}"
        user: "{{ virl_username }}"
        password: "{{ virl_password }}"
        name: "{{ inventory_hostname }}"
        lab: "{{ virl_lab }}"
        state: stopped
      tags:
        - stop
        - wipe

    - name: Wipe the node
      virl_node:
        host: "{{ virl_host }}"
        user: "{{ virl_username }}"
        password: "{{ virl_password }}"
        name: "{{ inventory_hostname }}"
        lab: "{{ virl_lab }}"
        state: wiped
      tags:
        - wipe

- hosts: localhost
  connection: local
  gather_facts: no
  roles:
    - ansible-virl
  tasks:
    - name: Delete the lab
      virl_lab:
        host: "{{ virl_host }}"
        user: "{{ virl_username }}"
        password: "{{ virl_password }}"
        lab: "{{ virl_lab }}"
        state: absent
